# Система балансировки на уровне характеристик

## Обзор

Реализована продвинутая система анализа баланса, которая работает на уровне **характеристик**, а не целых карт. Это позволяет точно определить, какие именно характеристики недооценены или переоценены, и автоматически предложить комплексную перебалансировку всей системы с целыми числами.

## Ключевые особенности

### 1. Анализ на уровне характеристик

Вместо того чтобы просто смотреть на винрейт карт, система:
- Анализирует винрейт каждой характеристики отдельно
- Учитывает, как часто характеристика используется
- Определяет реальную силу характеристики на основе статистики боев

### 2. Автоматический расчет множителей

Для каждой характеристики система рассчитывает:
- **Новые поинты силы**: Скорректированные на основе винрейта
- **Множитель значений**: Коэффициент, на который нужно умножить значения характеристики в картах

**Пример:**
```
Характеристика "Урон" имеет:
- Текущие поинты силы: 1.0
- Винрейт: 65% (слишком сильная!)
- Предложенные поинты силы: 2.54
- Множитель: 0.394 (= 1.0 / 2.54)

Это означает: если карта имела урон 10, то после балансировки будет иметь урон 4 (10 × 0.394).
```

### 3. Масштабирование для целых чисел

После расчета всех множителей система:
1. Находит все дробные значения
2. Вычисляет общий масштабирующий множитель
3. Применяет его ко всем значениям, чтобы получить целые числа
4. Корректирует здоровье и ману/выносливость пропорционально

**Результат:** Все значения характеристик в картах - целые числа, но баланс сохраняется!

## Алгоритм работы

### Шаг 1: Сбор статистики по характеристикам

```typescript
Для каждой характеристики:
  - Подсчитать количество появлений в боях
  - Подсчитать количество побед/поражений
  - Рассчитать винрейт
```

### Шаг 2: Расчет новых поинтов силы

```typescript
winRateDeviation = winRate - 50%
baseAdjustment = winRateDeviation × 0.02
usageWeight = min(totalUsages / 50, 1.5)
weightedAdjustment = baseAdjustment × usageWeight
suggestedPP = currentPP + weightedAdjustment
multiplier = currentPP / suggestedPP
```

### Шаг 3: Применение множителей к картам

```typescript
Для каждой карты:
  Для каждой характеристики в карте:
    newValue = currentValue × multiplier
    newPP = newPowerPoints × newValue
```

### Шаг 4: Масштабирование для целых чисел

```typescript
// Найти максимальное количество десятичных знаков
maxDecimals = max(decimals in all newValues)
scalingMultiplier = 10^maxDecimals

// Проверить и скорректировать, если нужно
while (есть дробные числа):
  scalingMultiplier += 1

// Применить
finalValue = round(newValue × scalingMultiplier)
```

### Шаг 5: Расчет целевых параметров героя

```typescript
targetHealth = round(baseHealth × scalingMultiplier / 10) × 10
targetMana = round(baseMana × scalingMultiplier / 10) × 10
targetStamina = round(baseStamina × scalingMultiplier / 10) × 10
```

## Интерфейс системы

### Секция 1: Анализ характеристик

Показывает таблицу со всеми характеристиками:
- Текущие и предложенные поинты силы
- Изменение (положительное = характеристика слишком сильная)
- Множитель для значений
- Винрейт при использовании
- Количество использований
- Детальное обоснование

### Секция 2: Идеальная сбалансированная система

Главная секция, которая содержит:

#### 2.1 Целевые параметры системы
- Здоровье героя
- Мана героя
- Выносливость героя
- Масштабирующий множитель

#### 2.2 Таблица перебалансировки характеристик
Показывает для каждой характеристики:
- Текущие и новые поинты силы
- Изменение поинтов
- Множитель для значений в картах

#### 2.3 Примеры перебалансированных карт
Интерактивные блоки, показывающие:
- Название карты
- Изменение общих поинтов силы
- Детальная таблица с каждой характеристикой:
  - Было (значение)
  - Стало (значение) - **целое число!**
  - PP было
  - PP стало

#### 2.4 Пошаговая инструкция
Детальное руководство по применению изменений

## Математические основы

### Целевая функция

Цель системы - минимизировать отклонение винрейта всех карт от 50%:

```
minimize: Σ |WinRate(card_i) - 50%|
```

### Балансировка через характеристики

Вместо изменения карт целиком, мы изменяем характеристики:

```
CardPower = Σ (CharacteristicValue_i × CharacteristicPowerPoints_i)

Если CardPower ≈ 0 и все характеристики сбалансированы,
то WinRate(card) ≈ 50%
```

### Масштабирование

Для сохранения баланса при масштабировании:

```
Если Health × k и Damage × k,
то соотношение Damage/Health сохраняется
⇒ баланс сохраняется
```

## Примеры использования

### Пример 1: Переоцененная атака

**Начальная ситуация:**
- Характеристика "Урон": 1 PP, винрейт 68%
- Карта "Огненный шар": Урон 15 (15 PP)

**После анализа:**
- Новые PP для "Урон": 2.5 PP
- Множитель: 0.4
- Новое значение для карты: 15 × 0.4 = 6

**После масштабирования (допустим, множитель = 2):**
- Финальное значение: 6 × 2 = 12 (целое число!)
- Здоровье героя также × 2

**Результат:** Баланс сохранён, все числа целые!

### Пример 2: Недооцененная защита

**Начальная ситуация:**
- Характеристика "Защита": 1 PP, винрейт 35%
- Карта "Щит": Защита 8 (8 PP)

**После анализа:**
- Новые PP для "Защита": 0.6 PP
- Множитель: 1.67
- Новое значение для карты: 8 × 1.67 = 13.36

**После масштабирования (множитель = 3):**
- Финальное значение: 13.36 × 3 = 40 (целое!)
- Все остальные значения также × 3

**Результат:** Защита стала эффективнее, баланс достигнут!

## Преимущества подхода

### 1. Точность
- Анализирует реальную силу каждой характеристики
- Учитывает взаимодействие характеристик в картах
- Основывается на реальных данных боев

### 2. Комплексность
- Одновременно балансирует все характеристики
- Гарантирует, что карты стремятся к 0 PP
- Автоматически находит оптимальные параметры героя

### 3. Практичность
- Все значения - целые числа
- Ясные инструкции по применению
- Примеры для каждой карты

### 4. Масштабируемость
- Работает с любым количеством характеристик
- Работает с любым количеством карт
- Адаптируется к разным системам боя

## Ограничения и рекомендации

### Минимальные требования
- Минимум 100 симуляций для надежных результатов
- Минимум 10 использований каждой характеристики
- Разнообразие колод в симуляциях

### Рекомендации по применению

1. **Начните с анализа:**
   - Запустите 500-1000 симуляций
   - Изучите таблицу характеристик
   - Обратите внимание на характеристики с высоким отклонением

2. **Примените изменения поэтапно:**
   - Сначала обновите только характеристики
   - Проверьте результат
   - Затем обновите карты и героя

3. **Итерируйте:**
   - После применения запустите новые симуляции
   - Проверьте, улучшился ли баланс
   - При необходимости повторите процесс

4. **Используйте фиксированные характеристики:**
   - После балансировки проверяйте с фиксированными характеристиками
   - Это даст более точную картину баланса

### Когда НЕ использовать

- Если данных меньше 50 симуляций
- Если некоторые характеристики используются редко
- Если система боя сильно изменилась недавно

## Технические детали реализации

### Файлы
- `/workspace/src/utils/simulationAnalytics.ts` - Алгоритмы расчета
- `/workspace/src/pages/BattleSimulationPage.tsx` - UI компоненты
- `/workspace/src/pages/BattleSimulationPage.css` - Стили

### Ключевые функции

```typescript
// Анализ характеристик
calculateCharacteristicPowerPointSuggestions(
  analytics: SimulationAnalytics,
  allCards: Card[],
  characteristics: Characteristic[]
): CharacteristicPowerPointSuggestion[]

// Расчет сбалансированной системы
calculateBalancedSystem(
  analytics: SimulationAnalytics,
  allCards: Card[],
  characteristics: Characteristic[],
  baseHealth: number,
  baseMana: number,
  baseStamina: number
): BalancedSystemSuggestion | null
```

### Структуры данных

```typescript
interface CharacteristicPowerPointSuggestion {
  characteristicId: string;
  characteristicName: string;
  currentPowerPoints: number;
  suggestedPowerPoints: number;
  multiplier: number;
  adjustment: number;
  avgWinRateWhenUsed: number;
  totalUsages: number;
  reason: string;
}

interface BalancedSystemSuggestion {
  targetHealth: number;
  targetMana: number;
  targetStamina: number;
  scalingMultiplier: number;
  description: string;
  characteristicAdjustments: Array<...>;
  cardExamples: Array<...>;
}
```

## Заключение

Эта система представляет собой мощный инструмент для автоматической балансировки карточных игр. Она решает проблему на фундаментальном уровне - уровне характеристик, а не симптомов - уровне карт. 

Результат - математически обоснованная, практичная система с целыми числами, где все карты естественным образом стремятся к балансу.
