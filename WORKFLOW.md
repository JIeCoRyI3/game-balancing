# Схема Работы Системы Анализа

## 📊 Общая Архитектура

```
┌─────────────────────────────────────────────────────────┐
│           Множественные Симуляции                      │
│  (500-1000 боёв с рандомными характеристиками)        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              Сбор Данных                                │
│  - Винрейт каждой карты                                │
│  - Характеристики при победе/поражении                  │
│  - Количество появлений                                 │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        ▼            ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Общий    │  │ Точечный │  │ Диапазон │
│ Анализ   │  │ Анализ   │  │ Баланса  │
└──────────┘  └──────────┘  └──────────┘
```

## 🎯 Поток Работы Пользователя

### Шаг 1: Настройка Симуляций
```
[Выбор колод] → [Количество симуляций] → [Запуск]
     ↓
[Случайная генерация характеристик]
  - healthMultiplier: 1-10 (одинаково для обоих героев)
  - resourceMultiplier: 1-10 (одинаково для обоих героев)
     ↓
[Применение к обоим героям]
  - Hero1: baseHP × multiplier, baseMana × multiplier
  - Hero2: baseHP × multiplier, baseMana × multiplier
     ↓
[Проведение боёв]
```

### Шаг 2: Общий Анализ
```
[Сводная статистика]
     ↓
[Рекомендации по балансу]
     ↓
[Таблица аналитики карт]
     ↓
[Тепловая карта для каждой карты]
```

### Шаг 3: Точечный Анализ (НОВОЕ)
```
[Ввод: HP = 500, Mana = 300]
     ↓
[Фильтр: HP 450-550, Mana 250-350]
     ↓
[Подсчёт винрейта для каждой карты]
     ↓
[Ранжирование по эффективности]
     ↓
[Таблица с статусами карт]
```

### Шаг 4: Анализ Диапазонов (НОВОЕ)
```
[Разбиение на 5×5 сетку диапазонов]
     ↓
Для каждого диапазона:
  ├─ [Подсчёт винрейта карт]
  ├─ [Вычисление среднего отклонения]
  └─ [Оценка качества баланса]
     ↓
[Сортировка по качеству]
     ↓
[Топ-5 лучших диапазонов]
```

## 🔍 Детали Алгоритмов

### Алгоритм Точечного Анализа

```typescript
Вход: 
  - targetHealth: 500
  - targetManaStamina: 300
  - tolerance: 50 (по умолчанию)

Процесс:
1. Фильтр боёв:
   healthMin = 500 - 50 = 450
   healthMax = 500 + 50 = 550
   resourceMin = 300 - 50 = 250
   resourceMax = 300 + 50 = 350

2. Для каждой карты:
   - Найти все бои где карта участвовала
   - Отфильтровать по диапазону характеристик
   - Подсчитать wins / total
   - Вычислить winRate и deviation

3. Сортировка:
   - По убыванию винрейта
   
Выход:
  - Список карт с винрейтами
  - Статусы (Сильная/Слабая/Сбалансирована)
```

### Алгоритм Поиска Лучших Диапазонов

```typescript
Вход:
  - Результаты симуляций
  - Сетка: 5×5 (настраивается)
  - baseHealth, baseResource

Процесс:
1. Создание сетки:
   maxHealth = baseHealth × 10
   maxResource = baseResource × 10
   healthStep = maxHealth / 5
   resourceStep = maxResource / 5
   
2. Для каждой ячейки сетки (h, r):
   healthRange = [h×step, (h+1)×step]
   resourceRange = [r×step, (r+1)×step]
   
   Для каждой карты:
     - Подсчитать винрейт в этом диапазоне
     - Вычислить |winRate - 50|
     
   avgDeviation = среднее(все_отклонения)
   
3. Фильтрация:
   - Минимум 3 боя на карту
   - Минимум 2 карты в диапазоне
   - Минимум 5 боёв всего
   
4. Сортировка:
   - По возрастанию avgDeviation
   
Выход:
  - Топ-5 диапазонов с лучшим балансом
  - Детали по каждой карте в диапазоне
```

## 📈 Метрики Качества

### Качество Баланса Диапазона

```
Отлично:   avgDeviation < 5%
Хорошо:    avgDeviation < 10%
Приемлемо: avgDeviation < 15%
Плохо:     avgDeviation ≥ 15%
```

### Статус Карты

```
Сильная:         winRate > 60%
Выше среднего:   winRate 55-60%
Сбалансирована:  winRate 45-55%
Ниже среднего:   winRate 40-45%
Слабая:          winRate < 40%
```

### Достоверность Данных

```
Высокая:    total ≥ 20 боёв
Средняя:    total 10-19 боёв
Низкая:     total 5-9 боёв
Недост.:    total < 5 боёв (не показывается)
```

## 🎨 Визуальная Карта Интерфейса

```
┌────────────────────────────────────────────────────┐
│  📊 Результаты Симуляций                           │
├────────────────────────────────────────────────────┤
│                                                    │
│  ┌──────────┬──────────┬──────────┬──────────┐   │
│  │ Всего    │ Карт     │ Колод    │ Проблем  │   │
│  │ Боёв     │          │          │          │   │
│  └──────────┴──────────┴──────────┴──────────┘   │
│                                                    │
│  🔧 Рекомендации по балансу                       │
│  ┌────────────────────────────────────────┐       │
│  │ ⚠️ Огненный Шар - Слишком сильна      │       │
│  │ ⬇️ Лечение - Слишком слаба           │       │
│  └────────────────────────────────────────┘       │
│                                                    │
│  📈 Таблица Аналитики Карт                        │
│  [Детальная таблица со всеми метриками]          │
│                                                    │
│  📉 Тепловая Карта (для выбранной карты)          │
│  [5×5 сетка с винрейтами]                        │
│                                                    │
│  🎯 Винрейт при конкретных характеристиках ◄ НОВОЕ│
│  ┌────────────────────────────────────────┐       │
│  │ HP: [____] Mana: [____] [Анализ]      │       │
│  │                                        │       │
│  │ Результаты:                            │       │
│  │ #1 Карта A - 75% - Сильная            │       │
│  │ #2 Карта B - 52% - Сбалансирована     │       │
│  │ #3 Карта C - 48% - Сбалансирована     │       │
│  └────────────────────────────────────────┘       │
│                                                    │
│  ⚖️ Лучшие диапазоны баланса         ◄ НОВОЕ    │
│  ┌────────────────────────────────────────┐       │
│  │ 🏆 #1 Диапазон (Лучший баланс!)       │       │
│  │ HP: 200-400, Mana: 100-200            │       │
│  │ Среднее откл: 3.45%                   │       │
│  │ [Детали по картам ▼]                  │       │
│  └────────────────────────────────────────┘       │
│  ┌────────────────────────────────────────┐       │
│  │ #2 Диапазон                            │       │
│  │ HP: 400-600, Mana: 200-300            │       │
│  └────────────────────────────────────────┘       │
│  ...                                              │
└────────────────────────────────────────────────────┘
```

## 🔄 Типичные Сценарии Использования

### Сценарий 1: Первичная Балансировка

```
1. Создать несколько тестовых колод
2. Запустить 100 симуляций
3. Посмотреть на общую аналитику
4. Найти очевидно дисбалансные карты
5. Исправить их
6. Повторить с 500 симуляциями
```

### Сценарий 2: Определение Базовых Характеристик

```
1. Не знаете какие базовые HP/Mana задать?
2. Запустите 1000 симуляций с широким диапазоном
3. Откройте "Лучшие диапазоны баланса"
4. Посмотрите на #1 диапазон
5. Установите базовые характеристики в середину этого диапазона
6. Например: #1 показывает HP 200-400 → baseHP = 300
```

### Сценарий 3: Fine-Tuning Для Конкретных Условий

```
1. Знаете что игроки обычно имеют HP=500, Mana=300
2. Откройте "Винрейт при конкретных характеристиках"
3. Введите HP=500, Mana=300
4. Проанализируйте
5. Увидите какие карты сильны именно в этих условиях
6. Настройте их специально под эти условия
```

### Сценарий 4: Проверка После Изменений

```
1. Внесли изменения в карты
2. Запустите 500 симуляций
3. Сравните новый #1 диапазон со старым
4. Проверьте улучшилось ли среднее отклонение
5. Посмотрите изменились ли проблемные карты
6. Используйте точечный анализ для проверки edge cases
```

## 🎓 Интерпретация Результатов

### Пример 1: Идеальный Баланс

```
#1 Диапазон
HP: 300-400, Mana: 150-250
Среднее отклонение: 2.8%

Карты:
- Огненный Шар: 51.2% (откл: 1.2%)
- Ледяная Стрела: 49.8% (откл: 0.2%)
- Лечение: 48.5% (откл: 1.5%)
- Щит: 52.1% (откл: 2.1%)

✅ Вывод: Отличный баланс! 
   Все карты в пределах 45-55%
   Среднее отклонение <5%
```

### Пример 2: Требует Внимания

```
#1 Диапазон
HP: 200-300, Mana: 100-150
Среднее отклонение: 12.5%

Карты:
- Огненный Шар: 68.3% (откл: 18.3%)
- Ледяная Стрела: 52.1% (откл: 2.1%)
- Лечение: 31.4% (откл: 18.6%)

⚠️ Вывод: Дисбаланс!
   Огненный Шар слишком силен
   Лечение слишком слабо
   При низких характеристиках баланс нарушен
```

### Пример 3: Точечный Анализ

```
Запрос: HP=1000, Mana=500

Результаты:
#1 Щит: 82.5% - Сильная
#2 Лечение: 71.3% - Сильная
#3 Огненный Шар: 45.2% - Сбалансирована

💡 Вывод: При высоких характеристиках
   защитные карты становятся имбовыми!
   Нужно добавить % урон или другой counter
```

---

**Используйте эту схему** для понимания как работает система и как интерпретировать результаты!
